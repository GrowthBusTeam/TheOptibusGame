<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Optibus Game | Exhibition Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --optibus-purple: #1a1040;
            --optibus-bg: #0d0628;
            --optibus-board: #1c1445;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--optibus-bg);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            touch-action: none;
            color: white;
        }

        canvas {
            display: block;
            touch-action: none;
        }

        .ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            box-sizing: border-box;
            z-index: 10;
        }

        .interactive {
            pointer-events: auto;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px 32px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
        }

        #timer-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
        }

        #timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #9d50bb, #f06292, #f57c00);
            width: 100%;
            transition: width 0.1s linear;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            text-align: center;
            width: 90%;
            max-width: 480px;
        }

        .btn {
            background: linear-gradient(45deg, #00d2ff, #9d50bb);
            color: #fff;
            padding: 18px 40px;
            border-radius: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
            width: 100%;
        }

        .btn:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 8px 25px rgba(157, 80, 187, 0.5);
        }

        input {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 16px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 20px;
            outline: none;
            transition: all 0.3s;
            font-size: 16px;
        }

        input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #00d2ff;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.1);
        }

        .leaderboard-row {
            display: grid;
            grid-template-columns: 40px 1fr 80px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            text-align: left;
            align-items: center;
            font-size: 14px;
        }

        .hidden { display: none !important; }

        #lb-list::-webkit-scrollbar { width: 4px; }
        #lb-list::-webkit-scrollbar-track { background: transparent; }
        #lb-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
    </style>
</head>
<body>

    <div class="ui-overlay">
        <!-- Header -->
        <div class="flex justify-between items-start">
            <div class="glass flex flex-col items-start gap-1">
                <span class="text-[9px] uppercase tracking-[0.4em] opacity-50 font-bold">Optimization Challenge</span>
                <svg viewBox="0 0 320 80" class="h-10">
                    <defs>
                        <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#00d2ff" />
                            <stop offset="33%" style="stop-color:#9d50bb" />
                            <stop offset="66%" style="stop-color:#f06292" />
                            <stop offset="100%" style="stop-color:#f57c00" />
                        </linearGradient>
                    </defs>
                    <text x="0" y="60" font-family="Arial, sans-serif" font-weight="900" font-size="64" fill="url(#logoGrad)" style="letter-spacing: -2px;">optibus</text>
                    <circle cx="178" cy="18" r="5" fill="#9d50bb" />
                </svg>
            </div>
            
            <div id="game-ui" class="hidden">
                <div class="glass text-right min-w-[160px]">
                    <span class="text-[9px] uppercase tracking-[0.3em] opacity-50 font-bold">Time Window</span>
                    <div id="timer-text" class="text-3xl font-mono font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">60.0s</div>
                    <div id="timer-bar"><div id="timer-fill"></div></div>
                </div>
            </div>
        </div>
        
        <!-- Mission Status (Bottom) -->
        <div id="instruction-ui" class="flex justify-center mb-6 hidden">
            <div class="glass text-center border-l-4 border-l-yellow-400 py-3 px-12">
                <p class="text-[9px] uppercase tracking-[0.3em] opacity-40 font-bold mb-1">Current Objective</p>
                <p class="text-base font-semibold tracking-wide">Optimize the route for the <span class="text-yellow-400 font-bold">GOLDEN BUS</span>!</p>
            </div>
        </div>
    </div>

    <!-- Registration Form -->
    <div id="registration-modal" class="modal glass interactive px-10 py-12">
        <h2 class="text-3xl font-black mb-1 italic tracking-tighter uppercase">The Optibus Game</h2>
        <p class="mb-10 text-sm text-gray-400">Exhibition Challenge: Optimize the Gridlock</p>
        
        <form onsubmit="event.preventDefault(); window.handleReg();" class="text-left">
            <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-2 block ml-1">Full Name</label>
            <input type="text" id="reg-name" placeholder="John Doe" required>
            
            <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-2 block ml-1">Company</label>
            <input type="text" id="reg-company" placeholder="Organization" required>
            
            <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-2 block ml-1">Work Email</label>
            <input type="email" id="reg-email" placeholder="john@company.com" required>
            
            <button type="submit" class="btn mt-4" id="reg-btn">Begin Optimization</button>
        </form>
    </div>

    <!-- Results / Leaderboard -->
    <div id="win-modal" class="modal glass interactive hidden px-10 py-12">
        <h2 class="text-4xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-cyan-400 italic">OPTIMIZED!</h2>
        <p id="win-message" class="mb-6 text-gray-300">Peak performance reached.</p>
        
        <div class="mb-8">
            <div class="flex justify-between items-end mb-4">
                <h3 class="text-xs uppercase tracking-widest font-bold text-cyan-400">Exhibition Leaderboard</h3>
                <span class="text-[10px] opacity-40">Live Rankings</span>
            </div>
            <div id="lb-list" class="max-h-48 overflow-y-auto pr-2"></div>
        </div>
        
        <button class="btn" onclick="window.resetGame()">New Route</button>
    </div>

    <!-- Fail -->
    <div id="lose-modal" class="modal glass interactive hidden px-10 py-12">
        <h2 class="text-4xl font-black mb-4 text-red-400 italic">GRIDLOCK!</h2>
        <p class="mb-8 text-gray-300">The schedule collapsed. Want to try another run?</p>
        <button class="btn" onclick="window.resetGame()">Restart Run</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA49is3JSblFjx6NZBjZnVRn134tlgJ4ps",
            authDomain: "growthbusgame.firebaseapp.com",
            projectId: "growthbusgame",
            storageBucket: "growthbusgame.firebasestorage.app",
            messagingSenderId: "140601102220",
            appId: "1:140601102220:web:c9bb33512e52dd6f84d0a9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'optibus-game-v1';

        let currentUser = null, userData = {}, leaderboard = [];
        let gameState = 'start', timeLeft = 60, lastTime = 0, buses = [], selectedBus = null, isDragging = false, dragOffset = 0;

        const colors = { target: '#ffd100', b1: '#00aaff', b2: '#9d50bb', b3: '#f06292', b4: '#f57c00', b5: '#4361EE', bg: '#0d0628' };

        const initAuth = async () => {
            try { await signInAnonymously(auth); } catch (e) { console.error("Auth error:", e); }
        };
        initAuth();

        onAuthStateChanged(auth, u => { 
            currentUser = u; 
            if(u) {
                const lbRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                onSnapshot(lbRef, s => {
                    leaderboard = s.docs.map(d => d.data()).sort((a,b) => b.score - a.score).slice(0, 10);
                    updateLBUI();
                }, err => console.error("Snapshot error:", err));
            }
        });

        const updateLBUI = () => {
            const list = document.getElementById('lb-list');
            if(!list) return;
            list.innerHTML = leaderboard.map((e, i) => `
                <div class="leaderboard-row ${e.email === userData.email ? 'text-cyan-400 font-bold' : 'text-gray-200'}">
                    <span class="opacity-40 text-[10px]">#${i+1}</span>
                    <span class="truncate pr-4">${e.name} <span class="opacity-50 text-[9px] uppercase ml-1">${e.company}</span></span>
                    <span class="text-right font-mono text-xs">${e.score}</span>
                </div>
            `).join('') || '<div class="text-sm opacity-30 py-6">No records yet.</div>';
        };

        class Bus {
            constructor(id, x, y, len, ori, col, isT = false) {
                Object.assign(this, {id, x, y, len, ori, col, isT, rx: x, ry: y});
            }
            draw(ctx, sz, ox, oy, isS) {
                const pad = sz * 0.1, r = sz * 0.25;
                let px = ox + this.rx * sz + pad, py = oy + this.ry * sz + pad;
                let pw = (this.ori === 'h' ? this.len * sz : sz) - pad * 2, ph = (this.ori === 'v' ? this.len * sz : sz) - pad * 2;
                
                ctx.save();
                if (this.isT) {
                    ctx.shadowColor = 'rgba(255, 209, 0, 0.6)'; ctx.shadowBlur = isS ? 30 : 20;
                } else {
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)'; ctx.shadowBlur = isS ? 20 : 10;
                }
                ctx.shadowOffsetY = isS ? 8 : 4;

                ctx.beginPath(); ctx.roundRect(px, py, pw, ph, r); ctx.fillStyle = 'rgba(20, 15, 45, 0.9)'; ctx.fill();
                ctx.shadowBlur = 0; ctx.shadowOffsetY = 0; ctx.strokeStyle = this.col; ctx.lineWidth = 3; ctx.stroke();

                ctx.fillStyle = '#ffffff';
                const dotR = 2.5, dotOff = 8;
                if(this.ori === 'h') {
                    ctx.beginPath(); ctx.arc(px + pw - dotOff, py + ph*0.25, dotR, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(px + pw - dotOff, py + ph*0.75, dotR, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.arc(px + pw*0.25, py + ph - dotOff, dotR, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(px + pw*0.75, py + ph - dotOff, dotR, 0, Math.PI*2); ctx.fill();
                }

                if(this.isT) {
                    ctx.fillStyle = '#ffffff';
                    let cx = px + pw/2, cy = py + ph/2, s = 10;
                    ctx.beginPath();
                    ctx.moveTo(cx + s*0.2, cy - s); ctx.lineTo(cx - s*0.4, cy + s*0.1); ctx.lineTo(cx - s*0.1, cy + s*0.1);
                    ctx.lineTo(cx - s*0.3, cy + s); ctx.lineTo(cx + s*0.4, cy - s*0.1); ctx.lineTo(cx + s*0.1, cy - s*0.1);
                    ctx.fill();
                }
                if(isS) { ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2; ctx.stroke(); }
                ctx.restore();
            }
        }

        window.handleReg = () => {
            userData = { 
                name: document.getElementById('reg-name').value, 
                company: document.getElementById('reg-company').value, 
                email: document.getElementById('reg-email').value 
            };
            document.getElementById('registration-modal').classList.add('hidden');
            ['game-ui', 'instruction-ui'].forEach(id => document.getElementById(id).classList.remove('hidden'));
            gameState = 'playing'; initLvl();
        };

        const initLvl = () => {
            buses = [
                new Bus(0,0,2,2,'h',colors.target, true), new Bus(1,2,0,3,'v',colors.b1), new Bus(2,3,1,2,'h',colors.b2),
                new Bus(3,5,0,3,'v',colors.b3), new Bus(4,0,4,3,'h',colors.b4), new Bus(5,4,3,2,'v',colors.b5),
                new Bus(6,0,0,2,'v',colors.b2), new Bus(7,3,4,2,'v',colors.b1), new Bus(8,4,5,2,'h',colors.b3)
            ];
            buses.forEach(b => { b.rx = b.x; b.ry = b.y; });
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.resetGame = () => { ['win-modal','lose-modal'].forEach(id => document.getElementById(id).classList.add('hidden')); gameState='playing'; timeLeft=60; initLvl(); };

        function update(t) {
            if(gameState === 'playing') {
                timeLeft -= lastTime ? (t - lastTime)/1000 : 0;
                if(timeLeft <= 0) { gameState='lose'; document.getElementById('lose-modal').classList.remove('hidden'); }
                document.getElementById('timer-text').innerText = Math.max(0, timeLeft).toFixed(1)+'s';
                document.getElementById('timer-fill').style.width = (timeLeft/60*100)+'%';
            }
            lastTime = t;
            let sz = Math.min(canvas.width, canvas.height)*0.7/6, ox = (canvas.width-sz*6)/2, oy = (canvas.height-sz*6)/2;
            buses.forEach(b => { if(selectedBus?.id !== b.id) { b.rx += (b.x-b.rx)*0.25; b.ry += (b.y-b.ry)*0.25; }});
            
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = '#1c1445'; ctx.beginPath(); ctx.roundRect(ox-20, oy-20, sz*6+40, sz*6+40, 20); ctx.fill();
            ctx.fillStyle = colors.bg; ctx.fillRect(ox, oy, sz*6, sz*6);
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            for(let i=0; i<=6; i++) { ctx.beginPath(); ctx.moveTo(ox+i*sz, oy); ctx.lineTo(ox+i*sz, oy+sz*6); ctx.stroke(); ctx.beginPath(); ctx.moveTo(ox, oy+i*sz); ctx.lineTo(ox+sz*6, oy+i*sz); ctx.stroke(); }
            buses.forEach(b => b.draw(ctx, sz, ox, oy, selectedBus?.id === b.id));
            requestAnimationFrame(update);
        }

        const getP = e => ({ x: (e.touches?.[0]?.clientX || e.clientX), y: (e.touches?.[0]?.clientY || e.clientY) });
        const canM = (b, nx, ny) => !buses.some(o => o.id !== b.id && nx < o.x + (o.ori==='h'?o.len:1) && nx + (b.ori==='h'?b.len:1) > o.x && ny < o.y + (o.ori==='v'?o.len:1) && ny + (b.ori==='v'?b.len:1) > o.y);
        
        // --- Event Handlers (With Cleanup) ---
        const handleStart = e => {
            if(gameState!=='playing') return;
            let p = getP(e), sz = Math.min(canvas.width, canvas.height)*0.7/6, ox = (canvas.width-sz*6)/2, oy = (canvas.height-sz*6)/2;
            selectedBus = buses.find(b => {
                let bx=ox+b.x*sz, by=oy+b.y*sz, bw=(b.ori==='h'?b.len:1)*sz, bh=(b.ori==='v'?b.len:1)*sz;
                return p.x>=bx && p.x<=bx+bw && p.y>=by && p.y<=by+bh;
            });
            if(selectedBus) { isDragging = true; dragOffset = selectedBus.ori==='h' ? p.x - (ox+selectedBus.x*sz) : p.y - (oy+selectedBus.y*sz); }
        };

        const handleMove = e => {
            if(!isDragging || !selectedBus) return;
            e.preventDefault();
            let p = getP(e), sz = Math.min(canvas.width, canvas.height)*0.7/6, ox = (canvas.width-sz*6)/2, oy = (canvas.height-sz*6)/2;
            if(selectedBus.ori==='h') {
                let nx = (p.x-ox-dragOffset)/sz, gx = Math.round(Math.max(0, Math.min(6-selectedBus.len+(selectedBus.isT?1.5:0), nx)));
                if(canM(selectedBus, gx, selectedBus.y)) { selectedBus.rx = nx; selectedBus.x = gx; }
                if(selectedBus.isT && selectedBus.x >= 5) {
                    if (gameState !== 'win') { // Prevent double-submission
                        gameState='win'; 
                        document.getElementById('win-modal').classList.remove('hidden');
                        const score = Math.floor(timeLeft*100);
                        if(currentUser) {
                            addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), { 
                                ...userData, score: score, timestamp: Date.now() 
                            }).catch(err => console.error("Error saving score:", err));
                        }
                    }
                }
            } else {
                let ny = (p.y-oy-dragOffset)/sz, gy = Math.round(Math.max(0, Math.min(6-selectedBus.len, ny)));
                if(canM(selectedBus, selectedBus.x, gy)) { selectedBus.ry = ny; selectedBus.y = gy; }
            }
        };

        const handleEnd = () => { if(selectedBus){ selectedBus.rx=selectedBus.x; selectedBus.ry=selectedBus.y; } isDragging=false; selectedBus=null; };

        // Clean up old listeners if they exist (Fixes duplication in dev/preview)
        if (window._hS) window.removeEventListener('mousedown', window._hS);
        if (window._hS) window.removeEventListener('touchstart', window._hS);
        if (window._hM) window.removeEventListener('mousemove', window._hM);
        if (window._hM) window.removeEventListener('touchmove', window._hM);
        if (window._hE) window.removeEventListener('mouseup', window._hE);
        if (window._hE) window.removeEventListener('touchend', window._hE);

        window._hS = handleStart;
        window._hM = handleMove;
        window._hE = handleEnd;

        window.addEventListener('mousedown', handleStart);
        window.addEventListener('touchstart', handleStart, {passive: false});
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('mouseup', handleEnd);
        window.addEventListener('touchend', handleEnd);

        window.addEventListener('resize', resize); resize(); requestAnimationFrame(update);
    </script>
</body>
</html>
